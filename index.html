<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¿€æƒ…ç‰›ç‰› - çœŸäººè”æœºç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ffc107; --bg-dark: #121212; --green-table: #1b5e20; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: sans-serif; background: var(--bg-dark); color: #fff; height: 100vh; overflow: hidden; }

        /* å¤§å… */
        #lobby { position: fixed; top:0; left:0; width:100%; height:100%; z-index:99; background: #000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.3s; }
        #lobby.hidden { transform: translateY(-100%); pointer-events:none; }
        
        .panel { width: 90%; max-width: 320px; background: #222; padding: 20px; border-radius: 15px; border: 1px solid #444; }
        .input-box { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; }
        .btn-create { background: #ffc107; }
        .btn-join { background: #2196f3; color: white; }

        /* æ¸¸æˆå†… */
        #game { opacity: 0; transition: 0.5s; height: 100%; display: flex; flex-direction: column; }
        #game.active { opacity: 1; }

        .header { padding: 10px; background: #222; display: flex; justify-content: space-between; font-size: 14px; }
        .table { flex: 1; background: radial-gradient(circle, #2e7d32, #1b5e20); position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* åŒºåŸŸ */
        .zone { width: 100%; height: 140px; position: relative; display: flex; justify-content: center; align-items: center; }
        .opponent-zone { margin-bottom: 20px; }
        .my-zone { margin-top: 20px; }
        
        .zone-label { position: absolute; font-size: 12px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px; color: #fff; }
        .opponent-zone .zone-label { top: -10px; }
        .my-zone .zone-label { bottom: -10px; }

        /* ç‰Œ */
        .card { width: 50px; height: 70px; background: white; border-radius: 4px; margin: 0 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; position: relative; transition: 0.3s; box-shadow: 1px 1px 4px rgba(0,0,0,0.3); }
        .card.red { color: red; }
        .card.black { color: black; }
        .card.back { background: #b71c1c; background-image: repeating-linear-gradient(45deg, #b71c1c 0, #c62828 10px); }
        .card.back span { display: none; }
        
        /* ç»“æœ */
        .badge { position: absolute; background: gold; color: black; padding: 4px 10px; border-radius: 20px; font-weight: bold; opacity: 0; transform: scale(0); transition: 0.3s; z-index: 10; border: 2px solid white; box-shadow: 0 0 10px gold; }
        .badge.show { opacity: 1; transform: scale(1); }

        /* æ§åˆ¶ */
        .controls { padding: 15px; background: #111; text-align: center; }
        .game-btn { padding: 10px 30px; border-radius: 20px; border: none; font-size: 16px; font-weight: bold; background: #4caf50; color: white; }
        .game-btn:disabled { background: #444; color: #888; }
        
        /* IDæ˜¾ç¤º */
        .room-id-display { font-family: monospace; color: #ffc107; font-size: 18px; margin: 10px 0; text-align: center; word-break: break-all; user-select: text; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color:var(--primary); margin-bottom:20px;">ç‰›ç‰›è”æœºç‰ˆ</h1>
        <div class="panel">
            <input type="text" id="nickname" class="input-box" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" maxlength="8">
            <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
            
            <div id="create-section">
                <p style="color:#aaa; font-size:12px; margin-bottom:5px;">æ–¹å¼ä¸€ï¼šæˆ‘æ˜¯æˆ¿ä¸»</p>
                <button class="btn btn-create" onclick="createRoom()">åˆ›å»ºæˆ¿é—´ (ç”ŸæˆID)</button>
                <div id="my-room-id" class="room-id-display" style="display:none;"></div>
                <p id="wait-msg" style="color:#4caf50; font-size:12px; text-align:center; display:none;">ç­‰å¾…å¯¹æ‰‹åŠ å…¥...</p>
            </div>

            <div style="text-align:center; margin:15px 0; color:#666;">- OR -</div>

            <div id="join-section">
                <p style="color:#aaa; font-size:12px; margin-bottom:5px;">æ–¹å¼äºŒï¼šåŠ å…¥æˆ¿é—´</p>
                <input type="text" id="target-id" class="input-box" placeholder="ç²˜è´´æˆ¿ä¸»å‘æ¥çš„ID">
                <button class="btn btn-join" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>
        </div>
    </div>

    <div id="game">
        <div class="header">
            <span>ğŸ‘¤ <span id="p1-name">æˆ‘</span></span>
            <span style="color:#ffc107">VS</span>
            <span>ğŸ‘¤ <span id="p2-name">å¯¹æ‰‹</span></span>
        </div>
        <div class="table">
            <div class="zone opponent-zone">
                <span class="zone-label" id="p2-label">å¯¹æ‰‹</span>
                <div class="badge" id="p2-badge">ç‰›ç‰›</div>
                <div id="p2-cards" style="display:flex"></div>
            </div>

            <div style="font-size:40px; opacity:0.1; font-weight:900;">PK</div>

            <div class="zone my-zone">
                <span class="zone-label" id="p1-label">æˆ‘</span>
                <div class="badge" id="p1-badge">ç‰›ä¸ƒ</div>
                <div id="p1-cards" style="display:flex"></div>
            </div>
        </div>
        <div class="controls">
            <div id="status-text" style="color:#aaa; font-size:12px; margin-bottom:10px;">ç­‰å¾…å¼€å§‹...</div>
            <button id="main-btn" class="game-btn" onclick="handleAction()">å‡†å¤‡ / å‘ç‰Œ</button>
        </div>
    </div>

<script>
    // --- æ ¸å¿ƒå˜é‡ ---
    let peer = null;
    let conn = null;
    let isHost = false;
    let myName = "";
    let deck = [];
    
    // æ¸¸æˆçŠ¶æ€
    let gameState = {
        phase: 'idle', // idle, deal, result
        hostHand: [],
        clientHand: []
    };

    // --- è”æœºåˆå§‹åŒ– ---
    function initPeer() {
        // ä½¿ç”¨ PeerJS çš„å®˜æ–¹å…è´¹äº‘æœåŠ¡å™¨
        peer = new Peer(null, { debug: 2 });
        
        peer.on('open', (id) => {
            if(isHost) {
                document.getElementById('my-room-id').innerText = id;
                document.getElementById('my-room-id').style.display = 'block';
                document.getElementById('wait-msg').style.display = 'block';
                document.getElementById('join-section').style.display = 'none'; // æˆ¿ä¸»ä¸èƒ½å†ç‚¹åŠ å…¥
            }
        });

        // è¢«è¿æ¥ï¼ˆæˆ‘æ˜¯æˆ¿ä¸»ï¼‰
        peer.on('connection', (c) => {
            if(!isHost) { c.close(); return; } // é˜²æ­¢å¤šè¿
            conn = c;
            setupConnection();
            alert("å¯¹æ‰‹å·²åŠ å…¥ï¼æ¸¸æˆå¼€å§‹ï¼");
            enterGameUI();
            // åŒæ­¥åå­—
            conn.send({ type: 'NAME', name: myName });
        });
        
        peer.on('error', (err) => alert("è”æœºé”™è¯¯: " + err.type));
    }

    // --- ç”¨æˆ·æ“ä½œ ---
    function createRoom() {
        myName = document.getElementById('nickname').value || "æˆ¿ä¸»";
        if(!myName) return alert("è¯·è¾“å…¥æ˜µç§°");
        isHost = true;
        initPeer();
        document.getElementById('p1-name').innerText = myName;
        document.getElementById('p1-label').innerText = myName;
    }

    function joinRoom() {
        myName = document.getElementById('nickname').value || "ç©å®¶";
        const targetId = document.getElementById('target-id').value.trim();
        if(!targetId) return alert("è¯·è¾“å…¥æˆ¿é—´ID");
        
        isHost = false;
        peer = new Peer(); // å®¢æˆ·ç«¯ä¹Ÿè¦åˆå§‹åŒ–
        peer.on('open', () => {
            conn = peer.connect(targetId);
            setupConnection();
        });
    }

    function setupConnection() {
        conn.on('open', () => {
            if(!isHost) {
                // å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ
                enterGameUI();
                conn.send({ type: 'NAME', name: myName });
                document.getElementById('p1-name').innerText = myName;
                document.getElementById('p1-label').innerText = myName;
                document.getElementById('main-btn').innerText = "ç­‰å¾…æˆ¿ä¸»å‘ç‰Œ";
                document.getElementById('main-btn').disabled = true;
                document.getElementById('status-text').innerText = "å·²è¿æ¥ï¼Œç­‰å¾…æˆ¿ä¸»...";
            }
        });

        conn.on('data', (data) => {
            handleNetworkData(data);
        });
        
        conn.on('close', () => alert("å¯¹æ–¹å·²æ–­å¼€è¿æ¥"));
    }

    // --- æ¸¸æˆé€»è¾‘ (æˆ¿ä¸»ä¸»å¯¼) ---
    function createDeck() {
        const suits = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
        const vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        deck = [];
        suits.forEach(s => vals.forEach(v => deck.push({s, v})));
        deck.sort(() => Math.random() - 0.5);
    }

    // æˆ¿ä¸»ç‚¹å‡»æŒ‰é’®
    function handleAction() {
        if (!isHost) return;

        if (gameState.phase === 'idle' || gameState.phase === 'result') {
            // å¼€å§‹å‘ç‰Œ
            createDeck();
            gameState.hostHand = deck.slice(0, 5);
            gameState.clientHand = deck.slice(5, 10);
            gameState.phase = 'deal';

            // å‘é€æ•°æ®ç»™å¯¹æ–¹
            const payload = {
                type: 'DEAL',
                hostHand: gameState.hostHand, // æˆ¿ä¸»çœ‹è‡ªå·±çš„
                clientHand: gameState.clientHand // å¯¹æ–¹çœ‹å¯¹æ–¹çš„
            };
            conn.send(payload); // å‘ç»™å®¢æœº
            renderGame(payload); // æ¸²æŸ“è‡ªå·±

            // æŒ‰é’®å˜äº®ç‰Œ
            updateBtn("å¼€ç‰Œ", true);
            sendBtnUpdate("ç­‰å¾…æˆ¿ä¸»å¼€ç‰Œ", false);

        } else if (gameState.phase === 'deal') {
            // å¼€ç‰Œ
            gameState.phase = 'result';
            const payload = { type: 'RESULT' };
            conn.send(payload);
            showResult();
            
            updateBtn("ä¸‹ä¸€å±€", true);
            sendBtnUpdate("ç­‰å¾…ä¸‹ä¸€å±€", false);
        }
    }

    // --- ç½‘ç»œæ•°æ®å¤„ç† ---
    function handleNetworkData(data) {
        switch(data.type) {
            case 'NAME':
                document.getElementById('p2-name').innerText = data.name;
                document.getElementById('p2-label').innerText = data.name;
                break;
            case 'DEAL':
                // è¿™é‡Œçš„ hostHand å…¶å®æ˜¯æˆ¿ä¸»çš„ç‰Œï¼ŒclientHand æ˜¯æˆ‘çš„ç‰Œ
                // ä½†åœ¨æ¸²æŸ“æ—¶ï¼Œæˆ‘çš„ç‰Œæ°¸è¿œåœ¨ä¸‹æ–¹ (p1)ï¼Œå¯¹æ‰‹åœ¨ä¸Šæ–¹ (p2)
                // å¦‚æœæˆ‘æ˜¯å®¢æœºï¼šp1 = clientHand, p2 = hostHand
                renderTable(data.clientHand, data.hostHand, false); 
                break;
            case 'RESULT':
                showResult();
                break;
            case 'BTN_UPDATE':
                const btn = document.getElementById('main-btn');
                btn.innerText = data.text;
                btn.disabled = !data.enable; // åªæœ‰æˆ¿ä¸»èƒ½æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œé€šå¸¸æ˜¯ false
                break;
        }
    }

    // --- æ¸²æŸ“é€»è¾‘ ---
    function enterGameUI() {
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('game').classList.add('active');
    }

    function updateBtn(text, enable) {
        const btn = document.getElementById('main-btn');
        btn.innerText = text;
        btn.disabled = !enable;
    }

    function sendBtnUpdate(text, enable) {
        if(conn) conn.send({ type: 'BTN_UPDATE', text, enable });
    }

    // æ¸²æŸ“æ¡Œé¢ï¼šmyCards æ˜¾ç¤ºåœ¨ä¸‹ï¼ŒopCards æ˜¾ç¤ºåœ¨ä¸Šï¼ˆæš—ç‰Œï¼‰
    function renderGame(data) {
        // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼šp1=hostHand, p2=clientHand
        // å¦‚æœæˆ‘æ˜¯å®¢æœºï¼šç”± handleNetworkData å†³å®š
        renderTable(data.hostHand, data.clientHand, false);
    }

    function renderTable(myCards, opCards, showOp) {
        const p1Div = document.getElementById('p1-cards');
        const p2Div = document.getElementById('p2-cards');
        p1Div.innerHTML = ''; p2Div.innerHTML = '';
        
        // éšè—ç»“æœ
        document.querySelectorAll('.badge').forEach(b => b.classList.remove('show'));

        // æ¸²æŸ“æˆ‘çš„ç‰Œ (æ˜ç‰Œ)
        myCards.forEach(c => p1Div.appendChild(createCardUI(c, false)));
        // æ¸²æŸ“å¯¹æ‰‹ç‰Œ (å‘ç‰Œé˜¶æ®µä¸ºæš—ç‰Œ)
        opCards.forEach(c => p2Div.appendChild(createCardUI(c, !showOp)));
        
        // æš‚å­˜æ•°æ®ç”¨äºå¼€ç‰Œè®¡ç®—
        if(isHost) {
            p1Div.dataset.hand = JSON.stringify(myCards);
            p2Div.dataset.hand = JSON.stringify(opCards);
        } else {
            // å®¢æœºæ”¶åˆ°çš„æ˜¯åçš„ï¼šmyCardsæ˜¯è‡ªå·±çš„, opCardsæ˜¯æˆ¿ä¸»çš„
            p1Div.dataset.hand = JSON.stringify(myCards);
            p2Div.dataset.hand = JSON.stringify(opCards);
        }
    }

    function createCardUI(card, isBack) {
        const div = document.createElement('div');
        div.className = `card ${isBack ? 'back' : (['â™¥','â™¦'].includes(card.s) ? 'red' : 'black')}`;
        if(!isBack) div.innerHTML = `<span>${card.v}</span><span style="font-size:20px">${card.s}</span>`;
        return div;
    }

    function showResult() {
        // ç¿»å¼€å¯¹æ‰‹çš„ç‰Œ
        const p2Div = document.getElementById('p2-cards');
        const opHand = JSON.parse(p2Div.dataset.hand);
        p2Div.innerHTML = '';
        opHand.forEach(c => p2Div.appendChild(createCardUI(c, false)));

        // è®¡ç®—ç‰›
        const p1Hand = JSON.parse(document.getElementById('p1-cards').dataset.hand);
        const p1Res = calNiu(p1Hand);
        const p2Res = calNiu(opHand);

        // æ˜¾ç¤ºBadge
        const b1 = document.getElementById('p1-badge');
        const b2 = document.getElementById('p2-badge');
        b1.innerText = p1Res.text; b1.classList.add('show');
        b2.innerText = p2Res.text; b2.classList.add('show');

        // åˆ¤å®š
        let status = "";
        if(p1Res.weight > p2Res.weight) status = "ä½ èµ¢äº†ï¼ğŸ‰";
        else if(p1Res.weight < p2Res.weight) status = "ä½ è¾“äº†...ğŸ˜­";
        else status = "å¹³å±€ ğŸ¤";
        
        document.getElementById('status-text').innerText = status;
        document.getElementById('status-text').style.color = "#fff";
    }

    function calNiu(hand) {
        let nums = hand.map(c => {
            if(['J','Q','K'].includes(c.v)) return 10;
            if(c.v === 'A') return 1;
            return parseInt(c.v);
        });
        let sum = nums.reduce((a,b)=>a+b,0);
        let best = 0; // 0=æ²¡ç‰›
        
        for(let i=0; i<3; i++)
        for(let j=i+1; j<4; j++)
        for(let k=j+1; k<5; k++) {
            if((nums[i]+nums[j]+nums[k])%10===0) {
                let left = (sum - (nums[i]+nums[j]+nums[k])) % 10;
                if(left === 0) left = 10; // ç‰›ç‰›
                if(left > best) best = left;
            }
        }
        
        const txts = ["æ²¡ç‰›","ç‰›ä¸€","ç‰›äºŒ","ç‰›ä¸‰","ç‰›å››","ç‰›äº”","ç‰›å…­","ç‰›ä¸ƒ","ç‰›å…«","ç‰›ä¹","ç‰›ç‰›"];
        return { weight: best, text: txts[best] };
    }
</script>
</body>
</html>
