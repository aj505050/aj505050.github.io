<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¿€æƒ…ç‰›ç‰› - è”æœºä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        :root { --primary: #ffc107; --bg-dark: #121212; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: sans-serif; background: var(--bg-dark); color: #fff; height: 100vh; overflow: hidden; }

        /* å¤§å…æ ·å¼ */
        #lobby { position: fixed; top:0; left:0; width:100%; height:100%; z-index:99; background: #000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #lobby.hidden { display: none; }
        
        .panel { width: 90%; max-width: 320px; background: #222; padding: 20px; border-radius: 15px; border: 1px solid #444; }
        .input-box { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; transition:0.2s;}
        .btn:active { transform: scale(0.95); }
        .btn-create { background: #ffc107; }
        .btn-join { background: #2196f3; color: white; }
        
        /* åŠ è½½çŠ¶æ€æ–‡å­— */
        .status-msg { font-size: 12px; text-align: center; margin-top: 10px; color: #aaa; min-height: 20px; }
        .error-msg { color: #ff5252; }

        /* æ¸¸æˆç•Œé¢ */
        #game { display: none; flex-direction: column; height: 100%; }
        #game.active { display: flex; }

        .header { padding: 10px; background: #222; display: flex; justify-content: space-between; font-size: 14px; border-bottom: 1px solid #333; }
        .table { flex: 1; background: radial-gradient(circle, #2e7d32, #1b5e20); position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .zone { width: 100%; height: 140px; position: relative; display: flex; justify-content: center; align-items: center; }
        .zone-label { position: absolute; font-size: 12px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px; color: #fff; }
        .opponent-zone .zone-label { top: -10px; }
        .my-zone .zone-label { bottom: -10px; }

        /* æ‰‘å…‹ç‰Œ */
        .card { width: 50px; height: 70px; background: white; border-radius: 4px; margin: 0 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; box-shadow: 1px 1px 4px rgba(0,0,0,0.3); }
        .card.red { color: red; } .card.black { color: black; }
        .card.back { background: #b71c1c; background-image: repeating-linear-gradient(45deg, #b71c1c 0, #c62828 10px); }
        .card.back span { display: none; }
        
        /* ç»“æœå¾½ç«  */
        .badge { position: absolute; background: gold; color: black; padding: 4px 10px; border-radius: 20px; font-weight: bold; opacity: 0; transform: scale(0); transition: 0.3s; z-index: 10; border: 2px solid white; }
        .badge.show { opacity: 1; transform: scale(1); }

        .controls { padding: 15px; background: #111; text-align: center; }
        .game-btn { padding: 10px 30px; border-radius: 20px; border: none; font-size: 16px; font-weight: bold; background: #4caf50; color: white; width: 80%; }
        .game-btn:disabled { background: #444; color: #888; }
        
        .room-id-display { font-family: monospace; color: #ffc107; font-size: 14px; margin: 10px 0; text-align: center; word-break: break-all; background:#000; padding:5px; border-radius:4px; border:1px dashed #666; user-select: text; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color:var(--primary); margin-bottom:20px;">ç‰›ç‰› (è”æœºä¿®å¤ç‰ˆ)</h1>
        <div class="panel">
            <input type="text" id="nickname" class="input-box" placeholder="è¾“å…¥æ˜µç§° (å¿…å¡«)" maxlength="8">
            
            <div id="lobby-status" class="status-msg">å‡†å¤‡å°±ç»ª</div>

            <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
            
            <div id="create-section">
                <button id="btn-create" class="btn btn-create" onclick="createRoom()">æˆ‘æ˜¯æˆ¿ä¸» (åˆ›å»º)</button>
                <div id="my-room-id" class="room-id-display" style="display:none;"></div>
            </div>

            <div style="text-align:center; margin:15px 0; color:#666;">- æˆ– -</div>

            <div id="join-section">
                <input type="text" id="target-id" class="input-box" placeholder="ç²˜è´´æˆ¿ä¸» ID">
                <button id="btn-join" class="btn btn-join" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>
        </div>
    </div>

    <div id="game">
        <div class="header">
            <span>ğŸ‘¤ <span id="p1-name">æˆ‘</span></span>
            <span style="color:#ffc107">VS</span>
            <span>ğŸ‘¤ <span id="p2-name">...</span></span>
        </div>
        <div class="table">
            <div class="zone opponent-zone">
                <span class="zone-label" id="p2-label">å¯¹æ‰‹</span>
                <div class="badge" id="p2-badge"></div>
                <div id="p2-cards" style="display:flex"></div>
            </div>
            <div style="font-size:40px; opacity:0.1; font-weight:900;">PK</div>
            <div class="zone my-zone">
                <span class="zone-label" id="p1-label">æˆ‘</span>
                <div class="badge" id="p1-badge"></div>
                <div id="p1-cards" style="display:flex"></div>
            </div>
        </div>
        <div class="controls">
            <div id="game-status" style="color:#aaa; font-size:12px; margin-bottom:10px;">ç­‰å¾…å¼€å§‹...</div>
            <button id="main-btn" class="game-btn" onclick="handleAction()">å‡†å¤‡</button>
        </div>
    </div>

<script>
    let peer = null;
    let conn = null;
    let isHost = false;
    let myName = "";
    
    // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
    window.onload = function() {
        if (typeof Peer === 'undefined') {
            updateStatus("é”™è¯¯ï¼šç½‘ç»œé˜»æ­¢äº†ç»„ä»¶åŠ è½½ï¼Œè¯·æŒ‚æ¢¯å­æˆ–åˆ·æ–°ï¼", true);
            document.querySelectorAll('button').forEach(b => b.disabled = true);
        }
    };

    function updateStatus(msg, isError = false) {
        const el = document.getElementById('lobby-status');
        el.innerText = msg;
        el.className = 'status-msg ' + (isError ? 'error-msg' : '');
    }

    function createRoom() {
        const name = document.getElementById('nickname').value;
        if(!name) return updateStatus("è¯·è¾“å…¥æ˜µç§°ï¼", true);
        
        myName = name;
        isHost = true;
        updateStatus("æ­£åœ¨è¿æ¥æœåŠ¡å™¨åˆ›å»ºæˆ¿é—´...", false);
        document.getElementById('btn-create').disabled = true;

        initPeer((id) => {
            updateStatus("æˆ¿é—´åˆ›å»ºæˆåŠŸï¼è¯·å¤åˆ¶ä¸‹æ–¹ ID ç»™å¥½å‹", false);
            const idBox = document.getElementById('my-room-id');
            idBox.style.display = 'block';
            idBox.innerText = id;
            document.getElementById('join-section').style.display = 'none';
        });
    }

    function joinRoom() {
        const name = document.getElementById('nickname').value;
        const targetId = document.getElementById('target-id').value.trim();
        
        if(!name) return updateStatus("è¯·è¾“å…¥æ˜µç§°ï¼", true);
        if(!targetId) return updateStatus("è¯·è¾“å…¥æˆ¿ä¸» IDï¼", true);

        myName = name;
        isHost = false;
        updateStatus("æ­£åœ¨å°è¯•è¿æ¥æœåŠ¡å™¨...", false);
        document.getElementById('btn-join').disabled = true;

        initPeer(() => {
            updateStatus("æœåŠ¡å™¨å·²è¿æ¥ï¼Œæ­£åœ¨å‘¼å«æˆ¿ä¸»...", false);
            connectToHost(targetId);
        });
    }

    function initPeer(onOpen) {
        try {
            // å¢åŠ  config æé«˜è¿æ¥æˆåŠŸç‡
            peer = new Peer(null, {
                debug: 2,
                config: {'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun1.l.google.com:19302' }
                ]}
            });
        } catch(e) {
            updateStatus("åˆå§‹åŒ–å¤±è´¥ï¼š" + e.message, true);
            return;
        }

        let isConnected = false;

        // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ5ç§’è¿ä¸ä¸ŠæœåŠ¡å™¨ï¼Œæç¤ºç”¨æˆ·
        setTimeout(() => {
            if(!isConnected) {
                updateStatus("è¿æ¥æœåŠ¡å™¨è¶…æ—¶ï¼è¯·æ£€æŸ¥ç½‘ç»œæˆ–ä½¿ç”¨ VPN", true);
                document.getElementById('btn-join').disabled = false;
                document.getElementById('btn-create').disabled = false;
            }
        }, 8000);

        peer.on('open', (id) => {
            isConnected = true;
            console.log('My Peer ID:', id);
            if(onOpen) onOpen(id);
        });

        peer.on('connection', (c) => {
            if(!isHost) { c.close(); return; }
            conn = c;
            setupConn();
        });

        peer.on('error', (err) => {
            console.error(err);
            let msg = "æœªçŸ¥é”™è¯¯";
            if(err.type === 'peer-unavailable') msg = "æ‰¾ä¸åˆ°è¯¥æˆ¿é—´ï¼Œè¯·æ£€æŸ¥ ID æ˜¯å¦æ­£ç¡®ï¼";
            if(err.type === 'network') msg = "ç½‘ç»œè¿æ¥æ–­å¼€";
            if(err.type === 'unavailable-id') msg = "ID æ— æ•ˆ";
            updateStatus("é”™è¯¯: " + msg, true);
            // æ¢å¤æŒ‰é’®
            document.getElementById('btn-join').disabled = false;
        });
    }

    function connectToHost(id) {
        conn = peer.connect(id);
        setupConn();
    }

    function setupConn() {
        conn.on('open', () => {
            // è¿æ¥æˆåŠŸï¼Œè¿›å…¥æ¸¸æˆ
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game').classList.add('active');
            
            // åˆå§‹åŒ–ç•Œé¢åå­—
            document.getElementById('p1-name').innerText = myName;
            document.getElementById('p1-label').innerText = myName;
            
            // å‘é€æˆ‘çš„åå­—ç»™å¯¹æ–¹
            conn.send({ type: 'NAME', name: myName });

            if(!isHost) {
                document.getElementById('main-btn').innerText = "ç­‰å¾…æˆ¿ä¸»å‘ç‰Œ";
                document.getElementById('main-btn').disabled = true;
                document.getElementById('game-status').innerText = "å·²æˆåŠŸåŠ å…¥æˆ¿é—´ï¼";
            } else {
                alert("ç©å®¶å·²åŠ å…¥ï¼å¯ä»¥å‘ç‰Œäº†");
                document.getElementById('p2-name').innerText = "ç©å®¶å·²è¿æ¥";
            }
        });

        conn.on('data', handleData);
        conn.on('close', () => alert("å¯¹æ–¹å·²æ–­å¼€è¿æ¥"));
    }

    // --- æ¸¸æˆé€»è¾‘ (å¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œç²¾ç®€ç‰ˆ) ---
    function handleAction() {
        if(!isHost) return;
        // ç®€å•çš„å‘ç‰Œé€»è¾‘
        const deck = createDeck();
        const hostHand = deck.slice(0, 5);
        const clientHand = deck.slice(5, 10);
        
        const payload = { type: 'DEAL', host: hostHand, client: clientHand };
        conn.send(payload); // å‘ç»™å®¢æœº
        renderGame(hostHand, clientHand, false); // æ¸²æŸ“è‡ªå·± (æˆ‘æ˜¯æˆ¿ä¸»)
    }

    function handleData(data) {
        if(data.type === 'NAME') {
            document.getElementById('p2-name').innerText = data.name;
            document.getElementById('p2-label').innerText = data.name;
        }
        if(data.type === 'DEAL') {
            // å®¢æœºæ¥æ”¶ï¼šclientæ˜¯æˆ‘çš„ç‰Œï¼Œhostæ˜¯å¯¹æ‰‹ç‰Œ
            renderGame(data.client, data.host, false); 
            // è‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºç»“æœ(ç®€åŒ–æµç¨‹)
            setTimeout(() => {
                showAllCards(data.client, data.host);
            }, 3000); // 3ç§’åè‡ªåŠ¨å¼€ç‰Œ
        }
    }

    function renderGame(myCards, opCards, showOp) {
        renderHand('p1-cards', myCards, false);
        renderHand('p2-cards', opCards, !showOp);
        document.getElementById('game-status').innerText = "å‘ç‰Œä¸­... 3ç§’åè‡ªåŠ¨å¼€ç‰Œ";
        // å­˜å‚¨æ•°æ®ç”¨äºå¼€ç‰Œ
        document.getElementById('game').dataset.my = JSON.stringify(myCards);
        document.getElementById('game').dataset.op = JSON.stringify(opCards);
    }

    function showAllCards(myCards, opCards) { // å¼ºåˆ¶å¼€ç‰Œ
        renderHand('p2-cards', opCards, false); // ç¿»å¼€å¯¹æ‰‹ç‰Œ
        
        const res1 = getNiu(myCards);
        const res2 = getNiu(opCards);
        
        showBadge('p1-badge', res1.text);
        showBadge('p2-badge', res2.text);
        
        let msg = res1.weight > res2.weight ? "ä½ èµ¢äº†ï¼" : "ä½ è¾“äº†...";
        if(res1.weight == res2.weight) msg = "å¹³å±€";
        document.getElementById('game-status').innerText = msg;
    }

    function renderHand(id, cards, isBack) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        cards.forEach(c => {
            const div = document.createElement('div');
            div.className = `card ${isBack ? 'back' : (['â™¥','â™¦'].includes(c.s)?'red':'black')}`;
            if(!isBack) div.innerHTML = `<span>${c.v}</span><span>${c.s}</span>`;
            el.appendChild(div);
        });
    }

    function showBadge(id, text) {
        const el = document.getElementById(id);
        el.innerText = text; el.classList.add('show');
    }

    function createDeck() {
        const s=['â™ ','â™¥','â™£','â™¦'], v=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let d=[]; s.forEach(si=>v.forEach(vi=>d.push({s:si,v:vi})));
        return d.sort(()=>Math.random()-0.5);
    }
    
    function getNiu(hand) {
        let nums = hand.map(c => ['J','Q','K'].includes(c.v)?10:(c.v=='A'?1:parseInt(c.v)));
        let sum = nums.reduce((a,b)=>a+b,0), best=0;
        for(let i=0;i<3;i++) for(let j=i+1;j<4;j++) for(let k=j+1;k<5;k++)
            if((nums[i]+nums[j]+nums[k])%10===0) {
                let r = (sum - (nums[i]+nums[j]+nums[k])) % 10;
                if(r===0) r=10; if(r>best) best=r;
            }
        const t=["æ²¡ç‰›","ç‰›ä¸€","ç‰›äºŒ","ç‰›ä¸‰","ç‰›å››","ç‰›äº”","ç‰›å…­","ç‰›ä¸ƒ","ç‰›å…«","ç‰›ä¹","ç‰›ç‰›"];
        return {weight:best, text:t[best]};
    }
</script>
</body>
</html>
