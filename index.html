<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¿€æƒ…ç‰›ç‰› - å®Œç¾åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        :root { --primary: #ffc107; --bg-dark: #121212; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: sans-serif; background: var(--bg-dark); color: #fff; height: 100vh; overflow: hidden; }

        /* å¤§å… */
        #lobby { position: fixed; top:0; left:0; width:100%; height:100%; z-index:99; background: #000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .panel { width: 90%; max-width: 320px; background: #222; padding: 20px; border-radius: 15px; border: 1px solid #444; }
        .input-box { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; }
        .btn-create { background: #ffc107; }
        .btn-join { background: #2196f3; color: white; }
        
        /* çŠ¶æ€æ¡ */
        .status-bar { text-align: center; font-size: 14px; margin-bottom: 10px; color: #aaa; min-height: 20px; }
        .status-active { color: #4caf50; font-weight: bold; }

        /* æ¸¸æˆæ¡Œ */
        #game { display: none; flex-direction: column; height: 100%; }
        #game.active { display: flex; }

        .header { padding: 15px; background: #1e1e1e; display: flex; justify-content: space-between; font-size: 16px; border-bottom: 1px solid #333; }
        .table { flex: 1; background: radial-gradient(circle, #2e7d32, #1b5e20); position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .zone { width: 100%; height: 150px; position: relative; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .zone-label { position: absolute; font-size: 12px; background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 12px; color: #fff; z-index: 2; }
        .opponent-zone .zone-label { top: 0; }
        .my-zone .zone-label { bottom: 0; }

        /* å¡ç‰Œ */
        .card { width: 55px; height: 80px; background: white; border-radius: 5px; margin: 0 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); font-size: 18px; }
        .card.red { color: #e91e63; } .card.black { color: #333; }
        .card.back { background: #b71c1c; background-image: repeating-linear-gradient(45deg, #b71c1c 0, #d32f2f 10px); border: 2px solid #fff; }
        .card.back * { display: none; }
        
        /* ç»“æœ */
        .badge { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(0); background: linear-gradient(45deg, #FFD700, #FFA500); color: #5c3a00; padding: 5px 15px; border-radius: 20px; font-weight: 900; z-index: 20; border: 2px solid #fff; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); white-space: nowrap; }
        .badge.show { transform:translate(-50%,-50%) scale(1.2); }
        .badge.lose { background: #9e9e9e; color: #333; box-shadow: none; }

        /* åº•éƒ¨æ§åˆ¶ */
        .controls { padding: 20px; background: #111; text-align: center; border-top: 1px solid #333; }
        .game-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 18px; font-weight: bold; background: #2e7d32; color: white; transition: 0.2s; }
        .game-btn:active { transform: scale(0.98); }
        .game-btn:disabled { background: #333; color: #777; cursor: not-allowed; }
        
        .room-id-box { background: #000; color: #ffc107; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; word-break: break-all; border: 1px dashed #555; user-select: text; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color:var(--primary); margin-bottom:20px;">ğŸ® æ¿€æƒ…ç‰›ç‰› V3</h1>
        <div class="panel">
            <input type="text" id="nickname" class="input-box" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
            <div id="lobby-msg" class="status-bar">å‡†å¤‡å°±ç»ª</div>
            
            <div id="step-1">
                <button class="btn btn-create" onclick="createRoom()">æˆ‘æ˜¯æˆ¿ä¸» (åˆ›å»º)</button>
                <div style="text-align:center; margin:15px 0; color:#555;">- OR -</div>
                <input type="text" id="target-id" class="input-box" placeholder="ç²˜è´´æˆ¿ä¸»ID">
                <button class="btn btn-join" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>

            <div id="step-2" style="display:none;">
                <p style="color:#aaa; font-size:12px;">é•¿æŒ‰å¤åˆ¶ä¸‹æ–¹IDå‘ç»™å¥½å‹ï¼š</p>
                <div id="my-room-id" class="room-id-box"></div>
                <p style="color:#4caf50; font-size:14px; text-align:center; margin-top:10px;">â³ ç­‰å¾…å¥½å‹åŠ å…¥...</p>
            </div>
        </div>
    </div>

    <div id="game">
        <div class="header">
            <div>ğŸ‘¤ <span id="p1-name">æˆ‘</span></div>
            <div style="color:#aaa; font-size:12px; line-height:24px;">VS</div>
            <div>ğŸ‘¤ <span id="p2-name">ç­‰å¾…ä¸­...</span></div>
        </div>
        
        <div class="table">
            <div class="zone opponent-zone">
                <span class="zone-label" id="p2-label">å¯¹æ‰‹</span>
                <div class="badge" id="p2-badge">ç‰›ç‰›</div>
                <div id="p2-cards" style="display:flex"></div>
            </div>

            <div id="game-tip" style="color:rgba(255,255,255,0.2); font-weight:bold; font-size:24px;">PK</div>

            <div class="zone my-zone">
                <span class="zone-label" id="p1-label">æˆ‘</span>
                <div class="badge" id="p1-badge">ç‰›ä¸ƒ</div>
                <div id="p1-cards" style="display:flex"></div>
            </div>
        </div>

        <div class="controls">
            <div id="game-status" style="color:#aaa; font-size:14px; margin-bottom:12px;">ç­‰å¾…å¼€å§‹...</div>
            <button id="main-btn" class="game-btn" onclick="hostDeal()" disabled>ç­‰å¾…è¿æ¥</button>
        </div>
    </div>

<script>
    // --- å…¨å±€å˜é‡ ---
    let peer, conn;
    let isHost = false;
    let myName = "ç©å®¶";
    let isRoundRunning = false;

    // --- 1. ç½‘ç»œè¿æ¥éƒ¨åˆ† ---
    function log(msg, error=false) {
        const el = document.getElementById('lobby-msg');
        el.innerText = msg;
        el.style.color = error ? '#ff5252' : '#aaa';
    }

    function initPeer(callback) {
        log("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...");
        try {
            peer = new Peer(null, { debug: 2 });
            peer.on('open', (id) => callback(id));
            peer.on('error', (err) => log("é”™è¯¯: " + err.type, true));
        } catch(e) { log("ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°", true); }
    }

    function createRoom() {
        myName = document.getElementById('nickname').value || "æˆ¿ä¸»";
        isHost = true;
        initPeer((id) => {
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
            document.getElementById('my-room-id').innerText = id;
            
            // æˆ¿ä¸»ç›‘å¬è¿æ¥
            peer.on('connection', (c) => {
                conn = c;
                setupGame();
            });
        });
    }

    function joinRoom() {
        myName = document.getElementById('nickname').value || "æŒ‘æˆ˜è€…";
        const id = document.getElementById('target-id').value;
        if(!id) return log("è¯·è¾“å…¥æˆ¿ä¸»ID", true);
        
        isHost = false;
        initPeer(() => {
            conn = peer.connect(id);
            setupGame();
        });
    }

    function setupGame() {
        conn.on('open', () => {
            // è¿æ¥æˆåŠŸï¼Œåˆ‡æ¢ç•Œé¢
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game').classList.add('active');
            
            // åˆå§‹åŒ–åå­—
            document.getElementById('p1-name').innerText = myName;
            document.getElementById('p1-label').innerText = myName;
            
            // äº¤æ¢åå­—
            conn.send({ type: 'NAME', name: myName });

            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            const btn = document.getElementById('main-btn');
            const status = document.getElementById('game-status');

            if (isHost) {
                btn.innerText = "âš¡ ç‚¹å‡»å‘ç‰Œ";
                btn.disabled = false;
                btn.style.background = "#4caf50";
                status.innerText = "âœ… ç©å®¶å·²è¿æ¥ï¼Œè¯·å‘ç‰Œï¼";
                status.className = "status-active";
            } else {
                btn.innerText = "â³ ç­‰å¾…æˆ¿ä¸»å‘ç‰Œ";
                btn.disabled = true;
                btn.style.background = "#333";
                status.innerText = "âœ… å·²è¿æ¥ï¼Œç­‰å¾…å¼€å±€...";
            }
        });

        conn.on('data', handleData);
        conn.on('close', () => alert("å¯¹æ–¹æ‰çº¿äº†"));
    }

    // --- 2. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---
    
    // æˆ¿ä¸»ç‚¹å‡»å‘ç‰Œ
    function hostDeal() {
        if(!isHost || isRoundRunning) return;

        // ç”Ÿæˆç‰Œå †
        const deck = createDeck();
        const hostCards = deck.slice(0, 5);
        const clientCards = deck.slice(5, 10);

        const payload = { type: 'ROUND_START', host: hostCards, client: clientCards };
        
        // å‘é€ç»™å¯¹æ–¹
        conn.send(payload);
        // è‡ªå·±å¼€å§‹
        runRound(payload);
    }

    // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
    function handleData(data) {
        if (data.type === 'NAME') {
            document.getElementById('p2-name').innerText = data.name;
            document.getElementById('p2-label').innerText = data.name;
        }
        if (data.type === 'ROUND_START') {
            runRound(data);
        }
    }

    // æ‰§è¡Œå›åˆ (åŒæ–¹é€šç”¨)
    function runRound(data) {
        isRoundRunning = true;
        const btn = document.getElementById('main-btn');
        const status = document.getElementById('game-status');
        
        // é‡ç½®ç•Œé¢
        document.querySelectorAll('.badge').forEach(b => b.classList.remove('show', 'lose'));
        status.innerText = "ğŸ’¥ å‘ç‰Œä¸­... 3ç§’åå¼€ç‰Œ";
        btn.disabled = true;
        btn.innerText = "ğŸ² æ­£åœ¨è®¡ç®—...";

        // è§£æç‰Œæ•°æ®
        // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼šæˆ‘çš„ç‰Œæ˜¯ data.hostï¼Œå¯¹æ‰‹æ˜¯ data.client
        // å¦‚æœæˆ‘æ˜¯é—²å®¶ï¼šæˆ‘çš„ç‰Œæ˜¯ data.clientï¼Œå¯¹æ‰‹æ˜¯ data.host
        const myHand = isHost ? data.host : data.client;
        const opHand = isHost ? data.client : data.host;

        // 1. æ¸²æŸ“æˆ‘çš„ç‰Œï¼ˆæ˜ç‰Œï¼‰
        renderHand('p1-cards', myHand, false);
        // 2. æ¸²æŸ“å¯¹æ‰‹ç‰Œï¼ˆæš—ç‰Œï¼‰
        renderHand('p2-cards', opHand, true);

        // 3. å€’è®¡æ—¶å¼€ç‰Œ
        let count = 3;
        const timer = setInterval(() => {
            count--;
            status.innerText = `â±ï¸ ${count} ç§’åå¼€ç‰Œ...`;
            if(count <= 0) {
                clearInterval(timer);
                showResult(myHand, opHand);
            }
        }, 1000);
    }

    // å¼€ç‰Œç»“ç®—
    function showResult(myHand, opHand) {
        // ç¿»å¼€å¯¹æ‰‹çš„ç‰Œ
        renderHand('p2-cards', opHand, false);

        // è®¡ç®—ç»“æœ
        const myRes = calNiu(myHand);
        const opRes = calNiu(opHand);

        // æ˜¾ç¤ºBadge
        showBadge('p1-badge', myRes.text);
        showBadge('p2-badge', opRes.text);

        // åˆ¤å®šè¾“èµ¢
        const status = document.getElementById('game-status');
        const btn = document.getElementById('main-btn');
        
        if (myRes.weight > opRes.weight) {
            status.innerText = "ğŸ‰ ä½ èµ¢äº†ï¼å¤§å‰å¤§åˆ©ï¼";
            status.style.color = "#ffeb3b";
            document.getElementById('p2-badge').classList.add('lose');
        } else if (myRes.weight < opRes.weight) {
            status.innerText = "ğŸ˜­ ä½ è¾“äº†... å†æ¥ä¸€æŠŠï¼Ÿ";
            status.style.color = "#ff5252";
            document.getElementById('p1-badge').classList.add('lose');
        } else {
            status.innerText = "ğŸ¤ å¹³å±€ï¼å’Œæ°”ç”Ÿè´¢";
            status.style.color = "#fff";
        }

        isRoundRunning = false;
        if(isHost) {
            btn.innerText = "ğŸ‘‰ ç‚¹å‡»å¼€å§‹ä¸‹ä¸€å±€";
            btn.disabled = false;
            btn.style.background = "#ff9800";
        } else {
            btn.innerText = "â³ ç­‰å¾…æˆ¿ä¸»ä¸‹ä¸€å±€";
        }
    }

    // --- 3. è¾…åŠ©å‡½æ•° ---
    function renderHand(id, cards, isBack) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        cards.forEach((c, i) => {
            const div = document.createElement('div');
            // ç®€å•çš„åŠ¨ç”»å»¶è¿Ÿ
            div.style.animation = `deal 0.3s ease-out ${i*0.1}s backwards`;
            div.className = `card ${isBack ? 'back' : (['â™¥','â™¦'].includes(c.s)?'red':'black')}`;
            if(!isBack) div.innerHTML = `<span>${c.v}</span><span style="font-size:14px">${c.s}</span>`;
            el.appendChild(div);
        });
    }
    
    function showBadge(id, text) {
        const el = document.getElementById(id);
        el.innerText = text; el.classList.add('show');
    }

    function createDeck() {
        const s=['â™ ','â™¥','â™£','â™¦'], v=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let d=[]; s.forEach(si=>v.forEach(vi=>d.push({s:si,v:vi})));
        return d.sort(()=>Math.random()-0.5);
    }

    function calNiu(hand) {
        // JQK=10, A=1
        let nums = hand.map(c => ['J','Q','K'].includes(c.v)?10:(c.v=='A'?1:parseInt(c.v)));
        let sum = nums.reduce((a,b)=>a+b,0), best=0;
        
        // æš´åŠ›ç®—ç‰›
        for(let i=0;i<3;i++) for(let j=i+1;j<4;j++) for(let k=j+1;k<5;k++)
            if((nums[i]+nums[j]+nums[k])%10===0) {
                let r = (sum - (nums[i]+nums[j]+nums[k])) % 10;
                if(r===0) r=10; if(r>best) best=r;
            }
        
        const t=["æ²¡ç‰›","ç‰›ä¸€","ç‰›äºŒ","ç‰›ä¸‰","ç‰›å››","ç‰›äº”","ç‰›å…­","ç‰›ä¸ƒ","ç‰›å…«","ç‰›ä¹","ğŸ®ç‰›ç‰›"];
        return {weight:best, text:t[best]};
    }
    
    // æ³¨å…¥CSSåŠ¨ç”»
    const style = document.createElement('style');
    style.innerHTML = `@keyframes deal { from { transform: translateY(-50px) scale(0.5); opacity:0; } to { transform: translateY(0) scale(1); opacity:1; } }`;
    document.head.appendChild(style);

</script>
</body>
</html>
